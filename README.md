# EasyAI - iOS AI聊天应用

一个现代化 iOS AI 聊天应用，通过 OpenRouter API 支持多个主流 AI 模型，提供流畅的聊天体验（SwiftUI + UIKit 混合实现）。

## 🎬 Demo

| 历史 | 聊天 | 设置 |
| --- | --- | --- |
| ![History Demo](history.gif) | ![Chat Demo](chat.gif) | ![Settings Demo](set.gif) |

## ✨ 功能特性

- 🎨 **现代化界面** - 轻量主题系统 + 统一卡片风格（SwiftUI + UIKit）
- 🤖 **多模型支持** - 通过 OpenRouter 支持多个 AI 模型（Claude、GPT、Gemini 等）
- 💬 **流式响应** - SSE 实时流式输出 + 可选本地“打字机”效果
- 🧠 **智能路由** - 可按任务类型与预算偏好自动切换更合适模型（手动/智能双模式）
- 🔁 **自动降级重试** - 请求失败后按策略自动 fallback 到其他模型（可配置重试次数与错误类型）
- 🖼️ **多模态输入** - 支持图片输入；相册多选（最多 5 张）+ 发送前预览/删除
- 🧩 **多图消息展示** - 聊天内图片消息支持多张横向滚动展示
- 🧱 **Prompt 模板** - 输入栏内置模板（会议纪要/翻译/代码讲解等），一键注入并可联动推荐模型
- 🎙️ **语音输入（STT）** - 支持语音转文字输入，边说边转写（需麦克风与语音识别权限）
- 🧾 **Markdown 渲染** - 标题/列表/引用/链接/代码块/图片/HTML/数学公式；代码块支持复制与导出分享
- ⌨️ **打字机体验** - 流式与非流式均可启用；表格即时显示，正文逐步呈现
- 🔊 **TTS 语音朗读** - 助手回复自动朗读；流式按句子结束串行播放；右上角静音/恢复
- 🔍 **智能模型选择** - 可搜索和筛选不同 AI 模型
- ⭐ **模型管理增强** - 收藏模型、记住上次选择、价格/上下文长度展示、仅免费筛选
- 📊 **对话指标与统计** - 消息级 Token/耗时/成本状态；模型页展示最近对话/路由效果/Provider 统计
- 🗂️ **对话历史管理** - 多会话列表、重命名、置顶、删除、搜索（标题+消息）
- 🎚️ **主色调切换** - 设置内可切换主色调并全局即时生效
- 🧭 **同级页面切换** - 会话/历史/设置同级左右滑动切换
- 💾 **本地持久化** - 会话与消息本地保存，冷启动可恢复
- 📱 **原生 iOS 体验** - 适配 iOS 15+
- ⚙️ **灵活配置** - 支持自定义 API Key 和模型参数
- 🧪 **调试体验** - 可选开启 phase 日志（turnId/itemId）便于排查流式与持久化问题
- ✍️ **输入栏增强** - 多行自适应、清空输入、图片预览/删除
- ⏳ **聊天体验优化** - 空状态、输入中“打点”动画、自动滚动黏底

## 📁 项目结构

```
easyAI/
├── App/                         # 应用入口/启动
├── Modules/                     # 业务模块（Chat/Conversations/Models/Settings/HistoryConversations）
└── Shared/                      # 共享层（Config/Networking/Persistence/Repositories/Security/UI/Models）
```

## 设置步骤

### 1. 配置 API Key

推荐方式：在 App 的“设置”页面录入 API Key，应用会存入 Keychain。

备用方式：在 `Info.plist` 中添加键 `OPENROUTER_API_KEY` 并填入 Key。

> **获取 API Key**: 访问 [OpenRouter.ai](https://openrouter.ai/) 注册并获取 API Key

**安全提示**：不要将 API Key 提交到版本控制系统。

### 2. 打开项目

1. 使用 Xcode 打开 `easyAI.xcodeproj`
2. 项目通过 SPM 管理依赖，首次打开会自动拉取（`WCDBSwift`、`RxSwift`、`RxDataSources`、`SnapKit`、`Kingfisher`、`Markdown`）

### 3. 运行项目

在 Xcode 中选择目标设备或模拟器，然后点击运行按钮 ▶️ 或按 `⌘ + R`

## 🎯 核心功能说明

### 流式响应
- 支持 Server-Sent Events (SSE) 流式响应
- 实时更新 AI 回复内容；结束后显示时间
- 可选“打字机”效果（流式/非流式均适用）
- 自动滚动跟随最新消息，键盘弹出/收起时保持“黏底”

### Markdown 渲染
- 支持常见 Markdown 元素（标题/列表/引用/代码块/链接等）
- 支持图片、HTML、数学公式（块级 `$$...$$` / 行内 `$...$`）
- 代码块支持一键复制与系统分享导出

### 聊天体验优化
- 空状态引导（开始对话提示）
- AI 回复加载中的“打点”动画
- 自动滚动跟随最新消息（保持黏底）
- 支持停止生成（发送按钮切换为停止）
  - 停止后：保留已显示文本、结束 loading、显示时间
  - 若停止时尚未输出正文：显示“已停止 + 时间”（不写入历史，仅当前会话 UI 展示）

### 多模态支持
- 支持图片输入（JPEG、PNG、GIF、WebP）
- AI 可以理解和分析图片内容
- 相册多选（最多 5 张）+ 发送前预览/删除
- 聊天内多图横向滚动展示（图片加载使用 Kingfisher 缓存）

### TTS 语音朗读
- 助手回复自动朗读（含流式与非流式）
- 流式输出按句号/问号/感叹号/换行切段，串行播放避免错乱
- 聊天页右上角喇叭按钮静音/恢复（静音为暂停，恢复继续）
- 播放前进行文本清洗（过滤 Emoji、Markdown、URL 等）

### Prompt 模板与语音输入
- 输入栏提供内置 Prompt 模板（会议纪要、润色改写、中英翻译、代码讲解、Bug 修复、图片分析、任务拆解、社媒文案）
- 点击模板可直接填充输入框；若命中推荐模型会自动切换
- 支持语音输入（Speech-to-Text），实时转写到输入框

### 智能路由与自动降级
- 路由模式支持手动/智能，智能模式会根据任务意图（代码/翻译/总结/写作/视觉）与预算偏好（免费优先/性价比/质量优先）推荐模型
- 支持自动降级重试：当限流/超时/服务不可用/网络异常等情况发生时，按策略切换模型继续请求
- 支持配置原生 fallback 深度（在一次请求内提供多级备用模型链）
- 多模态消息会优先选择支持图片输入的候选模型进行降级

### 消息指标与可观测性
- 助手消息状态栏可显示 Token、延迟、成本估算
- 会话内可展示运行状态文本（如智能路由命中、fallback 重试、错误分类）
- 模型选择页提供：
  - 最近对话统计（平均耗时/成本/Token）
  - 智能路由效果统计（命中率、成功率、耗时与成本变化）
  - Provider 累计统计（请求量、成功率、平均指标、错误分布）

### 模型管理
- 从 OpenRouter API 动态获取可用模型列表
- 支持搜索与多维筛选（输入/输出类型、仅免费、仅收藏）
- 支持刷新与加载失败提示
- 显示模型详细信息（多模态支持、输入/输出类型、价格、上下文长度）
- 收藏模型并置顶显示，记住上次选择的模型
- 上下文策略：全部上下文 / 仅文本 / 仅当前轮

### 对话历史与持久化
- 支持多会话列表（重命名、置顶、删除）
- 自动以首条用户消息生成会话标题
- 消息与会话使用本地数据库持久化

### 设置项（可在 App 内调整）
- API Key（Keychain 存储）
- 主色调切换（全局即时生效）
- 假数据模式（无需 Key，便于 UI 联调）
- 流式响应开关
- 打字机开关与速度/刷新率调节
- 自动降级开关、重试次数、原生 fallback 深度、Fallback 预算策略
- 错误类型重试开关（限流 / 超时 / 服务不可用 / 网络）
- 路由模式（手动 / 智能）与路由预算偏好（免费优先 / 性价比 / 质量优先）
- 语音朗读设置（音色/语速/音高）
- 上下文策略（全部 / 仅文本 / 仅当前轮）
- 最大 Token 数
- phase 日志开关（turnId/itemId）

## 📋 系统要求

- iOS 15.0+
- Swift 5.9+
- SwiftUI + UIKit
- Xcode 15.0+

## ⚠️ 注意事项

1. **API 费用**：使用 OpenRouter API 会产生费用，部分模型有免费额度，请注意 API 使用量
2. **网络连接**：应用需要网络连接才能调用 API
3. **API 限制**：请注意 OpenRouter API 的速率限制和配额限制
4. **API Key 安全**：请勿将 API Key 提交到公开仓库
5. **语音输入限制**：语音输入依赖系统语音识别与麦克风权限，模拟器不支持录音，请在真机测试

## 🚀 未来计划

暂无（当前版本已覆盖常用聊天产品的核心功能与完整链路，可直接作为长期迭代的基础工程）

## 📄 许可证

MIT License

## 🙏 致谢

- [OpenRouter](https://openrouter.ai/) - 提供统一的 AI 模型 API 接口
- SwiftUI / UIKit - Apple 原生 UI 框架

---

**⭐ 如果这个项目对你有帮助，请给个 Star！**
